var web_worker_rpc=function(e){var t={};function r(i){if(t[i])return t[i].exports;var s=t[i]={i:i,l:!1,exports:{}};return e[i].call(s.exports,s,s.exports,r),s.l=!0,s.exports}return r.m=e,r.c=t,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)r.d(i,s,function(t){return e[t]}.bind(null,s));return i},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){"use strict";r.r(t);const i={TIMEOUT:42e3,QPS:1e3,HEARTBEAT:4200,SUBSCRIBE_SIZE:64,ONERROR_LIMIT:64},s=self.inspect;let n=0,o=Math.floor(65536*Math.random());const l=(e,t,r)=>{let s=e[t];if(!s){s={},e[t]=s,void 0===e.SUBSCRIBE_SIZE&&(e.SUBSCRIBE_SIZE=0);let r=e.SUBSCRIBE_SIZE+1;if(r>=i.SUBSCRIBE_SIZE)return null;e.SUBSCRIBE_SIZE=r}let n=(()=>""+o++)();return s[n]=r,{subId:t,cbId:n}},u=(e,t,r,i,n,o)=>{let l=JSON.parse(e),u=l.type,a=l.reqId;if("req"===u||"send"===u){let e=l.fname,t=l.args,r=e.split("."),c=null,h=null;for(let t of r){if(!(c=n[t]))return s?console.error(`cannot find ${e} in ${s(n)}`):console.error(`cannot find ${e} env`),!0;h=n,n=c}try{h&&(c=c.bind(h));let e=[];for(let r=0;r<t.length;++r){let i=t[r];if(null!=i&&i.hasOwnProperty("subId")&&i.hasOwnProperty("cbId")){let t=i.subId,r=i.cbId;e.push((...e)=>{o({type:"cb",subId:t,cbId:r,args:e})})}else e.push(i)}let r=c(...e);"send"!==u?r&&r.then?r.then(e=>{o({type:"resp",reqId:a,res:e})},e=>{o({type:"resp",reqId:a,err:""+e})}):o({type:"resp",reqId:a,res:r}):r&&(i[a]=r)}catch(e){"send"!==u&&o({type:"resp",reqId:a,err:""+e})}}else if("resp"===u){let e=t[a];if(!e)return console.warn("resp timeout!"),!0;{delete t[a];let r=l.err;r?e.rej(r):e.res(l.res)}}else if("cb"===u){let e=l.subId,t=l.cbId,i=l.args,s=r[e];if(!s)return!0;let n=s[t];if(!n)return console.error(`no found callback for cbId:${t}`),!0;try{n(...i)}catch(e){return console.error(`__rspCB fail, ${e} `),!0}}else if("can"===u){let e=i[l.subId];if(e){delete i[l.subId];try{e()}catch(e){console.error("subscribe cancellor fail:"+e)}}}else if("fatal"===u)return!1;return!0},a=(e,t,r,i)=>{const s=(o,u)=>new Proxy(o,{get(o,a){let c;return s((...s)=>{n++,"apply"==a?s=(s=s.slice(1))[0]:"call"==a&&(s=s.slice(1));let o=[],u=!1;for(let e=0;e<s.length;++e){let i=s[e];if("function"==typeof i){let e=l(t,n,i);if(!e)return void r({type:"fatal"});o.push(e),u=!0}else o.push(i)}if(u){r({type:"send",reqId:n,fname:c,args:o});let e=n;return()=>{delete t[e],t.SUBSCRIBE_SIZE=t.SUBSCRIBE_SIZE-1,r({type:"can",subId:e})}}return new Promise((t,s)=>{e[n]={res:t,rej:s,tick:i.tick},r({type:"req",reqId:n,fname:c,args:o})})},c="apply"==a||"call"==a?u:""===u?a:`${u}.${a}`)}});return s({},"")};let c=(e,t)=>{return setInterval(()=>{let r=[];for(let i in e){let s=e[i];s.tick<t.tick&&r.push([i,s])}for(let t of r)t[1].rej("timeout exception"),delete e[t[0]];t.tick++},i.TIMEOUT)};if(self.window){let e=`importScripts('${document.currentScript.src}');\n`;class t{constructor(t,r){this.CONFIG=i,this.reqMap={},this.subMap={},this.canMap={},this.requestCount=0,this.onerrorCount=0,this.finishHandler=fetch(t).then(e=>e.text()).then(t=>{var s;try{s=new Blob([e,t],{type:"application/javascript"})}catch(r){console.log(r),window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,(s=new BlobBuilder).append(e),s.append(t),s=s.getBlob()}this.worker=new Worker(URL.createObjectURL(s)),r&&(this.exports=r),this.ticker={tick:0};let n=e=>{let t=JSON.stringify(e);this.worker.postMessage(t)};return this.worker.onmessage=e=>{if(this.requestCount++,this.requestCount>i.HEARTBEAT/1e3*i.QPS)return this.requestCount=0,void this.exitFail(`remote QPS > ${i.QPS}!`);u(e.data,this.reqMap,this.subMap,this.canMap,this.exports,n)||this.exitFail(`reach MAX subscribe limit > ${i.SUBSCRIBE_SIZE}!`)},this.worker.onerror=e=>{console.error(e),++this.onerrorCount>i.onerrorCount&&(this.requestCount=0,this.onerrorCount=0,this.exitFail("worker onerror"))},this.remote=a(this.reqMap,this.subMap,n,this.ticker),this.timeID=c(this.reqMap,this.ticker),this.__hbChecking=!1,this.onFail=()=>{console.error("remote fail to call, restart!")},this.__hb(),this})}dispose(){this.worker.terminate(),clearInterval(this.timeID),this.remote=new Proxy({},{get(e,t){throw new Error("remote is disposed!")}}),this.isClosed=!0;for(let e in this.canMap)setTimeout(()=>{(0,this.canMap[e])()},0)}exitFail(e){this.dispose(),setTimeout(()=>{e&&console.error(e),this.onFail()},0)}__hb(){setTimeout(async()=>{try{if(this.isClosed)return;if(this.__hbChecking)return void this.exitFail("remote fail to answer!");if(this.requestCount=0,this.__hbChecking=!0,this.__hb(),"r"!==await this.remote.__hb())throw new Error("heartbeat fail to return!");this.__hbChecking=!1}catch(e){return}},i.HEARTBEAT)}}self.__web_worker_rpc={create:(e,r)=>{return new t(e,r).finishHandler}}}else{let e={},t={},r={},s=e=>{let t=JSON.stringify(e);self.postMessage(t)};self.onmessage=i=>{u(i.data,e,t,r,Object.assign({__hb:()=>"r"},self.rpc.exports),s)};let n={tick:0,get timeout(){return self.timeout}};self.rpc={CONFIG:i},self.rpc.remote=a(e,t,s,n),setTimeout((function(){c(e,n)}),0)}t.default={}}]);
//# sourceMappingURL=web_worker_rpc.js.map